(function(){"use strict";const g=require("web3"),w=require("@truffle/contract"),f=require("../../build/contracts/Voting.json"),r=w(f);window.App={web3:null,account:null,start:async function(){try{if(typeof window.ethereum>"u")throw new Error("MetaMask is not installed");this.web3=new g(window.ethereum);const t=await window.ethereum.request({method:"eth_requestAccounts"});this.account=t[0],r.setProvider(this.web3.currentProvider),r.defaults({from:this.account,gas:6654755});const n=document.getElementById("accountAddress");n&&(n.innerText="Your Account: "+this.account);const e=await r.deployed();await this.loadAndBind(e)}catch(t){console.error("App initialization failed:",t),alert("Failed to connect to MetaMask: "+(t.message||t))}},loadCandidates:async function(t,n){try{const e=await t.getCountCandidates();n.innerHTML="";for(let a=1;a<=e;a++)try{const o=await t.getCandidate(a),c=o[0].toString(),l=o[1],u=o[2],m=o[3].toString(),d=document.createElement("tr");d.innerHTML=`
            <td>
              <input class="form-check-input" type="radio" name="candidate" value="${c}" id="cand-${c}">
              ${l}
            </td>
            <td>${u}</td>
            <td>${m}</td>
          `,n.appendChild(d)}catch(o){console.warn(`Skip candidate ${a}:`,o)}}catch(e){console.error("Failed to load candidates:",e)}},loadVotingDates:async function(t){const n=document.getElementById("dates");if(n)try{const e=await t.getDates(),a=new Date(e[0]*1e3),o=new Date(e[1]*1e3);n.innerText=`${a.toDateString()} - ${o.toDateString()}`}catch(e){console.warn("Could not load voting dates:",e)}},loadAndBind:async function(t){try{const n=document.getElementById("addCandidate"),e=document.getElementById("name"),a=document.getElementById("party"),o=document.getElementById("boxCandidate");n&&e&&a&&n.addEventListener("click",async()=>{const d=e.value.trim(),i=a.value.trim();if(!d||!i){alert("Please enter both name and party.");return}try{await t.addCandidate(d,i),alert("Candidate added successfully!"),e.value="",a.value="",o&&await this.loadCandidates(t,o)}catch(s){console.error("Add candidate failed:",s),alert("Failed to add candidate. Check console.")}});const c=document.getElementById("addDate"),l=document.getElementById("startDate"),u=document.getElementById("endDate");c&&l&&u&&c.addEventListener("click",async()=>{const d=l.value,i=u.value;if(!d||!i){alert("Please select both start and end dates.");return}try{const s=Math.floor(new Date(d).getTime()/1e3),y=Math.floor(new Date(i).getTime()/1e3);await t.setDates(s,y),alert("Voting dates updated!"),await this.loadVotingDates(t)}catch(s){console.error("Set dates failed:",s),alert("Failed to set dates. Check console.")}}),await this.loadVotingDates(t),o&&await this.loadCandidates(t,o);const m=document.getElementById("voteButton");if(m){const d=await t.checkVote();m.disabled=d}}catch(n){console.error("Failed to load voting data:",n)}},vote:async function(){const t=document.querySelector('input[name="candidate"]:checked');if(!t){const n=document.getElementById("msg");n&&(n.innerHTML="<p>Please select a candidate.</p>");return}try{await(await r.deployed()).vote(parseInt(t.value,10));const e=document.getElementById("voteButton");e&&(e.disabled=!0);const a=document.getElementById("msg");a&&(a.innerHTML="<p>Voted successfully!</p>")}catch(n){console.error("Voting failed:",n);const e=document.getElementById("msg");e&&(e.innerHTML="<p>Voting failed. Check console.</p>")}}},window.addEventListener("load",()=>{typeof window.ethereum<"u"?(console.log("MetaMask detected. Initializing..."),window.App.start()):alert("MetaMask is not installed. Please install it to use this dApp.")})})();
