(function(){"use strict";const g=require("web3"),w=require("@truffle/contract"),f=require("../../build/contracts/Voting.json"),r=w(f);window.App={web3:null,account:null,start:async function(){try{const t=localStorage.getItem("authToken");if(!t){alert("Please log in first to access this page."),window.location.href="/";return}const a=JSON.parse(atob(t.split(".")[1]));if(a.exp&&Date.now()>=a.exp*1e3){localStorage.removeItem("authToken"),localStorage.removeItem("userRole"),alert("Session expired. Please log in again."),window.location.href="/";return}if(typeof window.ethereum>"u")throw new Error("MetaMask is not installed");this.web3=new g(window.ethereum);const e=await window.ethereum.request({method:"eth_requestAccounts"});this.account=e[0],r.setProvider(this.web3.currentProvider),r.defaults({from:this.account,gas:6654755});const n=document.getElementById("accountAddress");n&&(n.innerText="Your Account: "+this.account);const o=await r.deployed();await this.loadAndBind(o)}catch(t){console.error("App initialization failed:",t),alert("Failed to connect to MetaMask: "+(t.message||t))}},loadCandidates:async function(t,a){try{const e=await t.getCountCandidates();a.innerHTML="";for(let n=1;n<=e;n++)try{const o=await t.getCandidate(n),c=o[0].toString(),l=o[1],u=o[2],m=o[3].toString(),d=document.createElement("tr");d.innerHTML=`
            <td>
              <input class="form-check-input" type="radio" name="candidate" value="${c}" id="cand-${c}">
              ${l}
            </td>
            <td>${u}</td>
            <td>${m}</td>
          `,a.appendChild(d)}catch(o){console.warn(`Skip candidate ${n}:`,o)}}catch(e){console.error("Failed to load candidates:",e)}},loadVotingDates:async function(t){const a=document.getElementById("dates");if(a)try{const e=await t.getDates(),n=new Date(e[0]*1e3),o=new Date(e[1]*1e3);a.innerText=`${n.toDateString()} - ${o.toDateString()}`}catch(e){console.warn("Could not load voting dates:",e)}},loadAndBind:async function(t){try{const a=document.getElementById("addCandidate"),e=document.getElementById("name"),n=document.getElementById("party"),o=document.getElementById("boxCandidate");a&&e&&n&&a.addEventListener("click",async()=>{const d=e.value.trim(),i=n.value.trim();if(!d||!i){alert("Please enter both name and party.");return}try{await t.addCandidate(d,i),alert("Candidate added successfully!"),e.value="",n.value="",o&&await this.loadCandidates(t,o)}catch(s){console.error("Add candidate failed:",s),alert("Failed to add candidate. Check console.")}});const c=document.getElementById("addDate"),l=document.getElementById("startDate"),u=document.getElementById("endDate");c&&l&&u&&c.addEventListener("click",async()=>{const d=l.value,i=u.value;if(!d||!i){alert("Please select both start and end dates.");return}try{const s=Math.floor(new Date(d).getTime()/1e3),h=Math.floor(new Date(i).getTime()/1e3);await t.setDates(s,h),alert("Voting dates updated!"),await this.loadVotingDates(t)}catch(s){console.error("Set dates failed:",s),alert("Failed to set dates. Check console.")}}),await this.loadVotingDates(t),o&&await this.loadCandidates(t,o);const m=document.getElementById("voteButton");if(m){const d=await t.checkVote();m.disabled=d}}catch(a){console.error("Failed to load voting data:",a)}},vote:async function(){const t=document.querySelector('input[name="candidate"]:checked');if(!t){const a=document.getElementById("msg");a&&(a.innerHTML="<p>Please select a candidate.</p>");return}try{await(await r.deployed()).vote(parseInt(t.value,10));const e=document.getElementById("voteButton");e&&(e.disabled=!0);const n=document.getElementById("msg");n&&(n.innerHTML="<p>Voted successfully!</p>")}catch(a){console.error("Voting failed:",a);const e=document.getElementById("msg");e&&(e.innerHTML="<p>Voting failed. Check console.</p>")}}},window.addEventListener("load",()=>{typeof window.ethereum<"u"?(console.log("MetaMask detected. Initializing..."),window.App.start()):alert("MetaMask is not installed. Please install it to use this dApp.")})})();
